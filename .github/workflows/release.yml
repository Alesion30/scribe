name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    strategy:
      matrix:
        arch: [arm64, x86_64]
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Build (Release)
        run: swift build -c release --arch ${{ matrix.arch }}

      - name: Prepare artifact
        run: |
          BINARY=".build/${{ matrix.arch }}-apple-macosx/release/scribe"
          ARTIFACT="scribe-macos-${{ matrix.arch }}"
          mkdir -p "$ARTIFACT"
          cp "$BINARY" "$ARTIFACT/scribe"
          tar czf "${ARTIFACT}.tar.gz" "$ARTIFACT"

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: scribe-macos-${{ matrix.arch }}
          path: scribe-macos-${{ matrix.arch }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep -oP 'version: "\K[^"]+' Sources/scribe/Scribe.swift)
          echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: artifacts

      - name: Create or update GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          FILES=$(find artifacts -name '*.tar.gz' -type f)
          gh release create "$TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --title "$TAG" \
            --target "$GITHUB_SHA" \
            --generate-notes \
            2>/dev/null || true
          gh release upload "$TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --clobber \
            $FILES
